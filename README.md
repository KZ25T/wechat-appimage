# å¾®ä¿¡ AppImage

ä½¿ç”¨ AppImage è¿è¡Œ Linux åŸç”Ÿå¾®ä¿¡ï¼Œä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•ï¼Œæ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿã€‚

[TOC]

## 1 é¡¹ç›®ç‰¹è‰²

- [x] **ä½¿ç”¨æ–¹ä¾¿**ï¼Œæ²¡æœ‰é…ç½®é—®é¢˜ï¼Œä¸‹è½½å³å¯è¿è¡Œï¼Œåˆ é™¤å³å¯å¸è½½ã€‚
- [x] **å…æƒé™**ï¼Œä»ä¸‹è½½åˆ°è¿è¡Œï¼Œæ— éœ€ sudo æƒé™ã€‚
- [x] **ä¸ä¿®æ”¹ç³»ç»Ÿ**ï¼Œæ— éœ€ä¿®æ”¹ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼ˆ`/etc/lsb-release`ç­‰ï¼‰
- [x] **ä¸ä¹±æ”¾æ–‡ä»¶**ï¼Œé™åˆ¶è¯»å†™ç›®å½•ï¼Œä»¥é˜²åœ¨æ“ä½œç³»ç»Ÿé‡Œåˆ°å¤„ä¹±æ”¾æ–‡ä»¶
- [x] **ä½“ç§¯å°**ï¼Œæœ€å°åªéœ€ 47MBï¼Œflatpak ç­‰æ–¹æ¡ˆéœ€è¦å¤šè¾¾ GB çº§åˆ«ã€‚
- [x] **é€‚é…å¤š**ï¼ŒDebian/RHEL/Arch/Gentoo ç­‰å‘è¡Œç‰ˆå‡å¯ä½¿ç”¨ã€‚

å…¶ä»–å®‰è£…æ–¹æ³•çš„ç¼ºç‚¹ï¼š

- ğŸ˜• **ä½¿ç”¨éº»çƒ¦**ï¼ŒåŸç‰ˆéœ€è¦å®‰è£… deb åŒ…ï¼Œæ— æ³•ç›´æ¥å¸è½½ï¼›flatpak ç­‰æ–¹å¼é…ç½®å¤æ‚ã€‚
- ğŸ˜• **éœ€è¦ root æƒé™**ï¼Œéœ€è¦ sudo æ‰èƒ½å®‰è£…ã€‚
- ğŸ˜• **ä¹±æ”¹ç³»ç»Ÿ**ï¼ŒåŸç‰ˆå¾®ä¿¡æœ‰å‘è¡Œç‰ˆæ£€æµ‹ï¼Œéœ€è¦ä¿®æ”¹ä¸€äº›ç³»ç»Ÿå…³é”®é…ç½®ã€‚
- ğŸ˜• **ä¹±æ”¾æ–‡ä»¶**ï¼Œå®¶ç›®å½•ã€`/var`ç›®å½•éƒ½æœ‰æ”¾ç½®ã€‚
- ğŸ˜• **ä½“ç§¯å¤§**ï¼Œéœ€è¦å‡ ç™¾ MB å­˜å‚¨ç©ºé—´ã€‚
- ğŸ˜• **é€‚é…å°‘**ï¼Œåªæœ‰ deb åŒ…ï¼Œæ²¡æœ‰ rpm/pkg ç­‰å®‰è£…åŒ…ã€‚

## 2 å‘è¡Œç‰ˆé€‚é…

ç›®å‰è¯¥é¡¹ç›®å·²æµ‹è¯•å¹¶æ”¯æŒ Debian/Arch/RHEL ç³»å‘è¡Œç‰ˆã€‚è¯¦ç»†é€‚é…æƒ…å†µæˆ–å…¶ä»–æ“ä½œè§[é€‚é…ç›®å½•](./distros.md)ã€‚

## 3 å¿«é€Ÿå¼€å§‹

æœ¬èŠ‚ä»…é’ˆå¯¹ `x86_64` æ¶æ„ï¼Œå…¶ä»–æ¶æ„è¯·è‡ªè¡Œæ‰“åŒ…ã€‚

### 3.1 æ£€æŸ¥è¿è¡Œç¯å¢ƒ

1. æ£€æŸ¥[é€‚é…ç›®å½•](./distros.md)ï¼Œæ£€æŸ¥è‡ªå·±çš„å‘è¡Œç‰ˆæ˜¯å¦æ”¯æŒï¼Œæˆ–è€…æ˜¯å¦éœ€è¦é¢å¤–çš„æ“ä½œã€‚æœªç»æµ‹è¯•çš„å‘è¡Œç‰ˆå¯èƒ½éœ€è¦è‡ªè¡Œä¿®å¤ä¸€äº›é—®é¢˜ã€‚æ¬¢è¿ç»è¿‡æµ‹è¯•åå‘æœ¬ä»“åº“æèµ· issueï¼Œæˆ‘å°†æ·»åŠ åˆ°é€‚é…ç›®å½•ã€‚
2. æ“ä½œç³»ç»Ÿéœ€è¦æœ‰ bwrap å‘½ä»¤ï¼ˆå¸¸è§å‘è¡Œç‰ˆéƒ½æœ‰ï¼‰ï¼Œè‹¥æ²¡æœ‰è¯·å‚è€ƒ[æ­¤ç½‘ç«™](https://command-not-found.com/bwrap)ã€‚
3. æ£€æŸ¥æ“ä½œç³»ç»Ÿæ˜¯å¦æœ‰ XDG ç”¨æˆ·ç›®å½•ï¼ˆå¸¸è§å‘è¡Œç‰ˆéƒ½æœ‰ï¼‰ï¼š
   - æŸ¥çœ‹ `~/.config/user-dirs.dirs`ï¼ˆå¿…é¡»æœ‰è¿™ä¸ªæ–‡ä»¶ï¼‰
   - ä¸Šè¿°æ–‡ä»¶é‡Œé¢è¦æœ‰ `XDG_DESKTOP_DIR`ã€`XDG_DOWNLOAD_DIR` å’Œ `XDG_DOCUMENTS_DIR`
   - è¿è¡Œæ—¶ï¼Œåœ¨ç”¨æˆ·ç›®å½•ä¸‹ï¼Œå¾®ä¿¡åªèƒ½è¯»å†™ï¼š
     - è¿™ä¸‰ä¸ªç›®å½•ï¼Œä¹Ÿå°±æ˜¯æ¡Œé¢ã€ä¸‹è½½ã€æ–‡æ¡£ï¼ˆåº”è¯¥å¤Ÿç”¨äº†ï¼Œä¸å¤Ÿç”¨çš„è‡ªå·±æ”¹æºç ï¼‰
     - å¾®ä¿¡æ•°æ®åº“æ–‡ä»¶ï¼ˆæ”¾åœ¨ `${XDG_DOCUMENTS_DIR}/xwechat_files` ä¸‹ï¼ŒåŸç”Ÿå¾®ä¿¡æ˜¯ `~/xwechat_files`ï¼‰
     - å¾®ä¿¡é…ç½®æ–‡ä»¶ï¼ˆ`~/.xwechat`ï¼‰
     - å­—ä½“é…ç½®æ–‡ä»¶å’Œï¼ˆå¯èƒ½æœ‰çš„ï¼‰æ˜¾ç¤ºé…ç½®æ–‡ä»¶ã€‚

### 3.2 è·å– AppImage æ–‡ä»¶å¹¶è¿è¡Œ

1. ä¸‹è½½ï¼šæ‰“å¼€[Releases](https://github.com/KZ25T/wechat-appimage/releases)ï¼Œä¾è¯´æ˜ä¸‹è½½ç¬¦åˆä½ çš„éœ€æ±‚çš„æœ€æ–°ç‰ˆæœ¬çš„æ–‡ä»¶ã€‚è‹¥ä½ ä¸çŸ¥é“ä¸‹è½½å“ªä¸€ä¸ªï¼Œè¯·ä¸‹è½½ `wechat-x86_64.AppImage`
2. ä¿®æ”¹æƒé™ï¼šæ‰¾åˆ°è¯¥æ–‡ä»¶ä¸‹è½½è·¯å¾„ï¼Œæ·»åŠ å¯æ‰§è¡Œæƒé™ï¼š`chmod a+x wechat-x86_64.AppImage`
3. è¿è¡Œï¼šä»å‘½ä»¤è¡Œè¿è¡Œ `./wechat-x86_64.AppImage`ï¼Œæˆ–åŒå‡»è¯¥æ–‡ä»¶è¿è¡Œã€‚

> è‹¥ä¸èƒ½è¿è¡Œæˆ–éœ€è¦å…¶ä»–å¸®åŠ©è¯·å‚é˜…[5.3èŠ‚](#53-è‹¥æ— æ³•ä½¿ç”¨-fuse3)

## 4 ä»æœ¬ä»“åº“æ„é€  AppImage

å¦‚æœéœ€è¦ä¿®æ”¹ AppRun é‡Œçš„å†…å®¹ï¼Œæˆ–è€…æ¶æ„ä¸ç¬¦ï¼Œä½ å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹æ³•è‡ªè¡Œæ‰“åŒ… AppImage è¿è¡Œã€‚

> æ³¨ï¼šæœ¬è¯´æ˜æš‚æœªç»™ x86_64 ä»¥å¤–çš„æ¶æ„ä»¥å®Œæ•´æ”¯æŒã€‚

### 4.1 ä¸‹è½½åŸåŒ…

1. ä¸‹è½½æœ¬ä»“åº“ã€‚
2. ä¸‹è½½ä¸€ä¸ªå¾®ä¿¡ Linux ç‰ˆæœ¬çš„ deb åŒ…ï¼Œä¸‹è½½åœ°å€ï¼š

   - [å¾çˆ±ç ´è§£](https://www.52pojie.cn/thread-1896902-1-1.html)ï¼Œæˆ–
   - [é“¶æ²³éº’éºŸdebä»“åº“](https://archive2.kylinos.cn/deb/kylin/production/PART-V10-SP1/custom/partner/V10-SP1/pool/all/)ï¼Œæœç´¢ `wechat-beta`

3. ä¸‹è½½â€œä¼˜éº’éºŸå¾®ä¿¡â€deb åŒ…ï¼š

   - [ä¼˜éº’éºŸå¾®ä¿¡](https://www.ubuntukylin.com/applications/106-cn.html)
   - è¿™ä¸ªåŒ…åªéœ€è¦æå– `libactivation.so` å¤‡ç”¨ã€‚

### 4.2 è‡ªè¡Œæ‰“åŒ…

è§£åŒ…ç¬¬ä¸€ä¸ª debï¼Œç§»æ¤æ–‡ä»¶ï¼š

```bash
# pwd ä¸ºä»“åº“æ ¹ç›®å½•
dpkg -X your_wechat.deb /tmp/out
cp -r /tmp/out/opt src         # å¤§éƒ¨åˆ†æ–‡ä»¶
mkdir -p src/usr/lib           # æŠŠç¬¬äºŒä¸ªå¾®ä¿¡çš„ libactivation.so æŒªè¿›æ¥
```

å®‰è£… appimagetoolï¼ˆè‡ªå·±ä¸Šç½‘æœï¼‰

æ‰“åŒ… appimageï¼š

```bash
# pwd ä¸ºä»“åº“æ ¹ç›®å½•
appimagetool ./src
```

å¯ä»¥å–å¾— `wechat-x86_64.AppImage`

### 4.3 å…¶ä»–æ¶æ„çš„æ³¨æ„äº‹é¡¹

å…¶ä»–æ¶æ„å¯èƒ½éœ€è¦ä¿®æ”¹ AppRun çš„ç¬¬ 72 è¡Œã€‚

## 5 é«˜çº§ç”¨æ³•

### 5.1 å®‰è£…è¿è¡Œ

å¦‚æœæ‚¨è®¡åˆ’é•¿æœŸä½¿ç”¨æœ¬ AppImageï¼Œé‚£ä¹ˆæˆ‘æ¨èåœ¨è¿™é‡Œå®‰è£…è¿è¡Œã€‚

```bash
# å®‰è£…
sudo ./wechat-x86_64.AppImage --install
# å¸è½½
sudo wechat --remove
```

å®‰è£…åä½ å¯ä»¥åœ¨æ¡Œé¢æ·»åŠ ç±»ä¼¼çš„å¯åŠ¨å™¨å›¾æ ‡ã€‚

å®‰è£…è¿‡ç¨‹åªæ¶‰åŠä¸‰ä¸ªæ–‡ä»¶ï¼š

```text
/usr/local/bin/wechat
/usr/local/share/icons/hicolor/256x256/apps/wechat.png
/usr/local/share/applications/wechat.desktop
```

å¦‚æœæƒ³è¦åœ¨æ¡Œé¢ä¸ŠåŠ ä¸Šå›¾æ ‡ï¼Œåªéœ€è¦æŠŠç¬¬ä¸‰ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°æ¡Œé¢ã€‚

### 5.2 æ›´å¤šåŠŸèƒ½

```bash
# å¸®åŠ©
./wechat-x86_64.AppImage --help
# è¿›å…¥ bwrap çš„ shell(bash)
./wechat-x86_64.AppImage --debug
# å…³é—­å¾®ä¿¡è¿›ç¨‹ï¼ˆæ—©æœŸç‰ˆæœ¬æ— æ³•é€€å‡ºï¼Œç°åœ¨åº”è¯¥ä¸éœ€è¦è¿™ä¸ªåŠŸèƒ½äº†ï¼‰
./wechat-x86_64.AppImage --kill
# æ£€æŸ¥æ›´æ–°ï¼ˆæ˜¾ç¤ºä¸‹è½½é“¾æ¥ï¼‰
./wechat-x86_64.AppImage --update
# ç¦æ­¢å¾®ä¿¡è¯»å–æ¡Œé¢
./wechat-x86_64.AppImage --no-user-desktop
# ç¦æ­¢å¾®ä¿¡è¯»å–ä¸‹è½½
./wechat-x86_64.AppImage --no-user-download
# ç¦æ­¢å¾®ä¿¡è¯»å–æ–‡æ¡£
./wechat-x86_64.AppImage --no-user-documents
# ç¦æ­¢å¾®ä¿¡è¯»å– /run ä¸‹çš„æ–‡ä»¶ï¼ˆå¯èƒ½ä¼šå¯¼è‡´ä¸ç¨³å®šï¼‰
./wechat-x86_64.AppImage --no-run-file
# å®‰è£…å›¾æ ‡ã€æ¡Œé¢æ–‡ä»¶ã€åº”ç”¨
sudo ./wechat-x86_64.AppImage --install
# å¸è½½å›¾æ ‡ã€æ¡Œé¢æ–‡ä»¶ã€åº”ç”¨
sudo wechat --remove
# è§£åŒ…æ–‡ä»¶ï¼ˆè¿™å±äº appimage çš„åŠŸèƒ½ï¼Œå‚è€ƒ appimage æ–‡æ¡£ï¼Œå…¶ä»– appimage åŠŸèƒ½ä¸å†åˆ—å‡ºï¼‰
./wechat-x86_64.AppImage --appimage-extract
```

### 5.3 è‹¥æ— æ³•ä½¿ç”¨ fuse3

å¦‚æœæ‚¨çš„å‘è¡Œç‰ˆæœªå®‰è£… `libfuse3`ï¼Œæˆ–å› ä¸ºæƒé™ã€å®¹å™¨ç­‰é™åˆ¶æ— æ³•åŠ è½½ `fuse` æ¨¡å—ï¼Œé‚£ä¹ˆæœ¬å¾®ä¿¡å°†ä¸èƒ½ç›´æ¥è¿è¡Œã€‚

æ‚¨å¯ä»¥å°è¯•åœ¨å‘½ä»¤åé¢åŠ ä¸Š `--appimage-extract-and-run`ï¼›å¦‚æœ‰å…¶å®ƒé€‰é¡¹ï¼Œåˆ™ä¸éœ€è¦æ”¹å˜ã€‚å¦‚ï¼š

```bash
./wechat-x86_64.AppImage --appimage-extract-and-run
./wechat-x86_64.AppImage --appimage-extract-and-run --help
./wechat-x86_64.AppImage --appimage-extract-and-run --no-run-file --no-user-download
```

## 6 å£°æ˜

æœ¬ä»“åº“ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä¸”æœªç»è¿‡ä¸¥æ ¼æµ‹è¯•ï¼Œä½¿ç”¨æœ¬ä»“åº“é€ æˆçš„ä¸€åˆ‡åæœç”±ä½¿ç”¨è€…è´Ÿè´£ã€‚

## 7 å‚è€ƒ

å‚è€ƒï¼š[ä¾äº‘'s Blog - ä½¿ç”¨ bwrap æ²™ç›’](https://blog.lilydjwg.me/2021/8/12/using-bwrap.215869.html)

å‚è€ƒï¼š[wechat-beta-bwrap](https://github.com/lfift/wechat-beta-bwrap)
